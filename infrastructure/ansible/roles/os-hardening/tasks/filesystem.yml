---
# Filesystem Hardening â€” NIST CM-6
# Secure mount options and file permissions

- name: Set correct permissions on /etc/passwd
  ansible.builtin.file:
    path: /etc/passwd
    owner: root
    group: root
    mode: "0644"

- name: Set correct permissions on /etc/shadow
  ansible.builtin.file:
    path: /etc/shadow
    owner: root
    group: root
    mode: "0000"

- name: Set correct permissions on /etc/group
  ansible.builtin.file:
    path: /etc/group
    owner: root
    group: root
    mode: "0644"

- name: Set correct permissions on /etc/gshadow
  ansible.builtin.file:
    path: /etc/gshadow
    owner: root
    group: root
    mode: "0000"

- name: Add /tmp tmpfs entry to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^\s*tmpfs\s+/tmp\s+'
    line: "tmpfs /tmp tmpfs {{ os_hardening_tmp_mount_options }},size=2g 0 0"
    state: present

- name: Mount /tmp with restricted options
  ansible.builtin.command:
    cmd: mount -o remount /tmp
  register: _tmp_mount
  changed_when: _tmp_mount.rc == 0
  failed_when: false

- name: Set sticky bit on world-writable directories
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      find / -xdev -type d \( -perm -0002 -a ! -perm -1000 \) 2>/dev/null | head -20
    executable: /bin/bash
  register: _world_writable_dirs
  changed_when: false

- name: Apply sticky bit to world-writable directories
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "o+t"
  loop: "{{ _world_writable_dirs.stdout_lines }}"
  when: _world_writable_dirs.stdout_lines | length > 0

- name: Disable automounting
  ansible.builtin.systemd:
    name: autofs
    state: stopped
    enabled: false
  failed_when: false
