---
# SSHD Hardening â€” NIST AC-17, IA-2
# Applies DISA STIG SSH settings for Rocky Linux 9

- name: Install openssh-server
  ansible.builtin.dnf:
    name: openssh-server
    state: present

- name: Configure SSHD with hardened settings
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: "/usr/sbin/sshd -t -f %s"
  notify: Restart sshd

- name: Ensure sshd is enabled and running
  ansible.builtin.systemd:
    name: sshd
    state: started
    enabled: true

- name: Set SSH banner
  ansible.builtin.copy:
    content: |
      *** WARNING ***
      This system is for authorized use only. All activity is monitored
      and recorded. Unauthorized access is prohibited and will be
      prosecuted to the fullest extent of the law.
    dest: /etc/issue.net
    owner: root
    group: root
    mode: "0644"

- name: Remove SSH host keys shorter than 3072 bits
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      for key in /etc/ssh/ssh_host_*_key; do
        bits=$(ssh-keygen -l -f "$key" 2>/dev/null | awk '{print $1}')
        if [ -n "$bits" ] && [ "$bits" -lt 3072 ] 2>/dev/null; then
          rm -f "$key" "${key}.pub"
          echo "removed $key"
        fi
      done
    executable: /bin/bash
  register: _ssh_key_cleanup
  changed_when: "'removed' in _ssh_key_cleanup.stdout"
