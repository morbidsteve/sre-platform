# Rocky Linux 9 Kickstart — Proxmox VE Packer Image Build
# Produces a minimal installation suitable for STIG hardening with QEMU guest agent.

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Installation source
cdrom
text

# Network
network --bootproto=dhcp --device=link --activate --onboot=on
network --hostname=sre-rocky9

# Authentication
rootpw --lock
user --name=packer --groups=wheel --plaintext --password=packer

# Security
selinux --enforcing
firewall --enabled --service=ssh

# Disk partitioning — STIG-compliant layout
zerombr
clearpart --all --initlabel
autopart --type=lvm --nohome

# Bootloader
bootloader --append="audit=1 audit_backlog_limit=8192" --location=mbr

# Packages — minimal server with QEMU guest agent
%packages --ignoremissing
@^minimal-environment
openssh-server
openssh-clients
sudo
curl
python3
python3-pip
cloud-init
qemu-guest-agent
-iwl*firmware
-plymouth
%end

# Post-install
%post --log=/root/ks-post.log
# Configure sudo for packer user
echo "packer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/packer
chmod 0440 /etc/sudoers.d/packer

# Enable SSH for Packer provisioning
systemctl enable sshd

# Enable QEMU guest agent for Proxmox integration
systemctl enable qemu-guest-agent

# Disable root SSH access
sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config

# Configure cloud-init for Proxmox (nocloud datasource)
cat > /etc/cloud/cloud.cfg.d/99-proxmox.cfg <<'CLOUDEOF'
datasource_list: [NoCloud, ConfigDrive, None]
datasource:
  NoCloud:
    seedfrom: /
CLOUDEOF
%end

# Reboot after installation
reboot --eject
