# Rocky Linux 9 Kickstart — Minimal Server for Packer Image Build
# This kickstart produces a minimal installation suitable for STIG hardening.

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Installation source
cdrom
text

# Network
network --bootproto=dhcp --device=link --activate --onboot=on
network --hostname=sre-rocky9

# Authentication
rootpw --lock
user --name=packer --groups=wheel --plaintext --password=packer

# Security
selinux --enforcing
firewall --enabled --service=ssh

# Disk partitioning — STIG-compliant layout
zerombr
clearpart --all --initlabel
autopart --type=lvm --nohome

# Bootloader
bootloader --append="audit=1 audit_backlog_limit=8192" --location=mbr

# Packages — minimal server
%packages --ignoremissing
@^minimal-environment
openssh-server
openssh-clients
sudo
curl
python3
python3-pip
cloud-init
-iwl*firmware
-plymouth
%end

# Post-install: configure sudo for packer user
%post --log=/root/ks-post.log
echo "packer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/packer
chmod 0440 /etc/sudoers.d/packer

# Enable SSH for Packer provisioning
systemctl enable sshd

# Disable root SSH access
sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
%end

# Reboot after installation
reboot --eject
